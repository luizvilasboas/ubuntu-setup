#!/usr/bin/env ruby

# frozen_string_literal: true

require_relative '../lib/app_installer'
require_relative '../lib/app_remover'
require_relative '../lib/config_installer'
require_relative '../lib/utils'

require 'json'

# Main class for the script
class Main
  include Logging

  def initialize(apps_json = 'apps.json', configs_json = 'configs.json')
    @apps_json = read_json(apps_json)
    @configs_json = read_json(configs_json)
  rescue StandardError => e
    logger.error "couldn't parse #{apps_json} or #{configs_json}: #{e}"
    exit 1
  end

  def install_config
    logger.info 'Installing configs...'
    @configs_json[:configs].each do |config|
      to = config[:to]
      match_data = to.match(%r{^~/})
      to = "#{Dir.home}/#{match_data.post_match}" if match_data

      from = File.expand_path(config[:from])

      ConfigInstaller.new(from, to).add_symlink
    end
  end

  def install_apps
    logger.info 'Installing applications...'
    @apps_json[:apps_to_install].each do |app|
      AppInstaller.new(app[:name], app[:package_name], app[:package_manager]).exec
    end
  end

  def remove_apps
    logger.info 'Removing applications...'
    @apps_json[:apps_to_remove].each do |app|
      AppRemover.new(app[:name], app[:package_name], app[:package_manager]).exec
    end
  end

  private

  def read_json(json_path)
    json_string = File.read json_path
    JSON.parse json_string, symbolize_names: true
  end
end

main = Main.new

main.install_apps
main.remove_apps
main.install_config
